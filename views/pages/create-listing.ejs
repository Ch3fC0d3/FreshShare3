<%- contentFor('style') %>
<style>
  /* Styles moved to main.css */
</style>
<link rel="stylesheet" href="/css/main.css?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>">
<link rel="stylesheet" href="/css/upc-scanner.css?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>">
<link rel="stylesheet" href="/css/autocomplete.css?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>">

<%- contentFor('body') %>
<div class="main-content">
  <div class="container py-4">
    <div class="create-listing-container">
      <h1 class="mb-1">Create New Listing</h1>
      <% if (user) { %>
      <div class="d-flex justify-content-end mb-3">
        <span class="badge bg-success">
          <i class="fas fa-user me-1"></i>
          Logged in as <strong><%= user.username %></strong>
        </span>
      </div>
      <% } %>
      <% if (!user) { %>
      <div class="alert alert-warning d-flex align-items-center" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <div>
          Please log in to create a listing. <a href="/login?redirect=/create-listing" class="alert-link">Log in</a>
        </div>
      </div>
      <% } %>
      
      <form id="createListingForm" data-auth="<%= !!user %>" data-user-id="<%= user ? user._id : '' %>" data-scanner-autostart="<%= (featureFlags && featureFlags.scannerAutoStart) ? 'true' : 'false' %>" enctype="multipart/form-data">
        <!-- Basic Information -->
        <div class="form-section">
          <h3>Basic Information</h3>
          <% if (user) { %>
          <div class="mb-3">
            <label for="saved-template" class="form-label">Use previous listing</label>
            <select class="form-select" id="saved-template">
              <option value="">Select a previous listing to prefill...</option>
            </select>
            <div class="form-text">Selecting a previous listing will pre-fill this form. Review and adjust before submitting.</div>
            <div id="templatesFetchStatus" class="form-text text-muted" style="display:none"></div>
            <a href="#" id="templatesRetry" class="small" style="display:none">Retry</a>
          </div>
          <% } %>
          <% if (user) { %>
          <div class="mb-3">
            <label for="groupId" class="form-label">Group*</label>
            <select class="form-select" id="groupId" name="groupId">
              <option value="">Loading your groups...</option>
            </select>
            <div id="groupHelp" class="form-text">Your listing will belong to this group.</div>
            <div class="error-message" id="group-error" style="display:none"></div>
          </div>
          <% } %>
          <div class="mb-3">
            <label for="title" class="form-label">Item*</label>
            <input type="text" class="form-control" id="title" name="title" required placeholder="Start typing to search for food items...">
            <div class="form-text">Type to search for food items from the USDA database</div>
          </div>
          
          <div class="mb-3">
            <label for="description" class="form-label">Description*</label>
            <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
            <div class="form-text">Describe your item in detail. Include features, packaging, and any other relevant information.</div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="price" class="form-label">Price*</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" required>
              </div>
              <div class="form-text">If Unit is <strong>Case</strong>, this Price is treated as the <strong>Case Price</strong>.</div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="priceUnit" class="form-label">Unit</label>
              <select class="form-select" id="priceUnit" name="priceUnit">
                <option value="each">Each</option>
                <option value="lb">Per pound (lb)</option>
                <option value="kg">Per kilogram (kg)</option>
                <option value="oz">Per ounce (oz)</option>
                <option value="bunch">Per bunch</option>
                <option value="hour">Per hour</option>
                <option value="case">Case</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="casePrice" class="form-label">Case Price</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="casePrice" name="casePrice" min="0" step="0.01" placeholder="Total price per case">
              </div>
              <div class="form-text">Total price for one wholesale case. Combine with Case Size below.</div>
              <div class="form-text" id="priceBreakdown"></div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="category" class="form-label">Category*</label>
              <select class="form-select" id="category" name="category" required>
                <option value="">Select a category</option>
                <option value="vegetables">Vegetables</option>
                <option value="fruits">Fruits</option>
                <option value="herbs">Herbs & Spices</option>
                <option value="grains">Grains</option>
                <option value="dairy">Dairy</option>
                <option value="meat">Meat</option>
                <option value="seafood">Seafood</option>
                <option value="pantry">Pantry</option>
                <option value="beverages">Beverages</option>
                <option value="baked_goods">Baked Goods</option>
                <option value="prepared_foods">Prepared Foods</option>
                <option value="seeds">Seeds & Seedlings</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="caseSize" class="form-label">Case Size</label>
              <input type="number" class="form-control" id="caseSize" name="caseSize" min="1" value="1" placeholder="Number of units per case">
              <div class="form-text">Enter the number of units in one wholesale case.</div>
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check form-switch mb-2">
              <input type="checkbox" class="form-check-input switch-lg" id="pieceOrdering-enabled" name="pieceOrdering[enabled]">
              <label class="form-check-label fw-semibold" for="pieceOrdering-enabled">Enable per-piece ordering with rolling cases</label>
            </div>
            <div class="alert alert-info py-2 po-explainer" role="alert">
              <i class="bi bi-info-circle me-1"></i>
              <strong>Shoppers reserve individual pieces</strong> up to a case. When the case fills, it locks and a new case opens automatically.
            </div>
          </div>
          
          <div class="mb-3">
            <label for="quantity" class="form-label">Quantity Available</label>
            <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1">
          </div>

          <!-- Group Buy -->
          <div class="form-section">
            <h3>Group Buy</h3>
            <div class="form-check form-switch mb-2">
              <input type="checkbox" class="form-check-input switch-lg" id="groupBuy-enabled" name="groupBuy[enabled]">
              <label class="form-check-label fw-semibold" for="groupBuy-enabled">Enable group buy</label>
            </div>
            <div class="alert alert-info py-2" role="alert">
              <i class="bi bi-people me-1"></i>
              Buyers can <strong>commit cases together</strong>. When the target is reached by the deadline, place the order.
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="groupBuy-minCases" class="form-label">Minimum Cases</label>
                <input type="number" min="1" step="1" class="form-control" id="groupBuy-minCases" name="groupBuy[minCases]" placeholder="e.g., 2">
              </div>
              <div class="col-md-4 mb-3">
                <label for="groupBuy-targetCases" class="form-label">Target Cases</label>
                <input type="number" min="1" step="1" class="form-control" id="groupBuy-targetCases" name="groupBuy[targetCases]" placeholder="e.g., 6">
              </div>
              <div class="col-md-4 mb-3">
                <label for="groupBuy-deadline" class="form-label">Deadline</label>
                <input type="datetime-local" class="form-control" id="groupBuy-deadline" name="groupBuy[deadline]">
              </div>
            </div>
          </div>
          
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="isOrganic" name="isOrganic">
            <label class="form-check-label" for="isOrganic">This product is organic</label>
          </div>
          
          <div class="mb-3">
            <label for="listing-upc" class="form-label">UPC Code</label>
            <div class="input-group">
              <input type="text" class="form-control" id="listing-upc" name="upcCode" placeholder="Enter UPC code or scan barcode">
              <button type="button" class="btn btn-primary upc-scan-btn" id="scan-upc-btn">
                <i class="fas fa-barcode"></i> Scan
              </button>
            </div>
            <div class="form-text">Scan or enter a UPC code to automatically fetch product information</div>
            <!-- Hidden field to capture a product image URL from UPC lookup (quick path) -->
            <input type="hidden" id="imageUrl" name="imageUrl" />
          </div>
        </div>
        
        <!-- Images -->
        <div class="form-section">
          <h3>Images</h3>
          <div class="image-upload-container" id="imageUploadContainer">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click to upload images or drag and drop</p>
            <p class="text-muted">Maximum 5 images, 5MB each. Supported formats: JPG, PNG</p>
            <input type="file" id="imageUpload" name="images" accept="image/jpeg, image/png" multiple>
          </div>
          
          <div class="image-preview-container" id="imagePreviewContainer">
            <!-- Image previews will be added here -->
          </div>
        </div>
        
        <!-- Location -->
        <div class="form-section">
          <h3>Location</h3>
          <div class="mb-3">
            <label for="address" class="form-label">Address</label>
            <input type="text" class="form-control" id="address" name="location[address]">
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="city" class="form-label">City*</label>
              <input type="text" class="form-control" id="city" name="location[city]" required>
            </div>
            
            <div class="col-md-3 mb-3">
              <label for="state" class="form-label">State*</label>
              <input type="text" class="form-control" id="state" name="location[state]" required>
            </div>
            
            <div class="col-md-3 mb-3">
              <label for="zipCode" class="form-label">Zip Code*</label>
              <input type="text" class="form-control" id="zipCode" name="location[zipCode]" required>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Map Location</label>
            <div class="location-map" id="locationMap"></div>
            <input type="hidden" id="latitude" name="location[coordinates][lat]">
            <input type="hidden" id="longitude" name="location[coordinates][lng]">
          </div>
        </div>
        
        <!-- Vendor selection -->
        <div class="form-section">
          <h3>Vendor <small class="text-muted">(optional)</small></h3>
          <% if (user) { %>
          <div class="row align-items-end">
            <div class="col-md-8 mb-3">
              <label for="saved-vendor" class="form-label">Saved Vendor</label>
              <select class="form-select" id="saved-vendor">
                <option value="">Select a saved vendor</option>
              </select>
              <div id="vendorsFetchStatus" class="form-text text-muted" style="display:none"></div>
              <a href="#" id="vendorsRetry" class="small" style="display:none">Retry</a>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label d-block">&nbsp;</label>
              <div class="d-grid gap-2">
                <button type="button" id="vendorQuickPickBtn" class="btn btn-secondary w-100"><i class="fas fa-user-check me-1"></i> Quick Pick</button>
                <a href="/vendors?return=/create-listing" class="btn btn-outline-secondary w-100"><i class="fas fa-plus me-1"></i> Add Vendor</a>
              </div>
            </div>
          </div>
          <% } %>
          <input type="hidden" id="vendorId" name="vendorId" />
        </div>

        <!-- Vendor Quick Pick Modal (Bootstrap) -->
        <div class="modal fade" id="vendorQuickPickModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Select a Vendor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="vendorQuickPickClose"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <input id="vendorQuickPickSearch" type="text" class="form-control" placeholder="Search vendors by name or city..." autocomplete="off">
                </div>
                <div id="vendorQuickPickList" class="list-group">
                  <div class="p-3 text-muted">Loadingâ€¦</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tags -->
        <div class="form-section">
          <h3>Tags</h3>
          <div class="mb-3">
            <label class="form-label">Add tags to help buyers find your listing</label>
            <div class="tag-input-container">
              <div class="tag-container" id="tagContainer">
                <!-- Tags will be added here -->
              </div>
              <input type="text" id="tagInput" placeholder="Add a tag and press Enter">
            </div>
            <div class="form-text">Press Enter to add a tag. Tags help buyers find your listing.</div>
          </div>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
          <button type="button" class="btn btn-outline-secondary me-md-2" id="cancelButton">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitButton" <%= user ? '' : 'disabled' %>>Create Listing</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Include UPC Scanner Modal -->
<%- include('../partials/upc-scanner-modal') %>

<%- contentFor('script') %>
<!-- Polyfill to prevent Quagga from using Function(...) path under strict CSP -->
<script src="https://cdn.jsdelivr.net/npm/regenerator-runtime@0.13.11/runtime.min.js"></script>
<!-- Include QuaggaJS for barcode scanning -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.2/dist/quagga.min.js"></script>
<!-- Include UPC Lookup Script -->
<script src="/js/upc-lookup.js?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>"></script>
<script src="/js/food-autocomplete.js?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>"></script>
<!-- Food API script removed - functionality now integrated in main code -->
<script src="/js/create-listing-page.js?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>"></script>
