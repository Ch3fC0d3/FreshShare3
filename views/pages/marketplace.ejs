<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreshShare Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>">
    <link rel="stylesheet" href="/css/cart.css?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>">
    <link rel="stylesheet" href="/css/image-optimization.css?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>">
    <!-- Removed preloads of missing images to avoid 404s -->
</head>
<body class="marketplace-page">
    <div class="main-container">
        <div class="marketplace-header">
            <h1 class="marketplace-title">Marketplace</h1>
            <div class="view-controls">
                <button class="view-btn active marketplace-btn" data-view="grid">
                    <i class="fas fa-th"></i>
                </button>
                <button class="view-btn marketplace-btn" data-view="list">
                    <i class="fas fa-list"></i>
                </button>
                <a href="/create-listing" class="create-listing-btn marketplace-btn">
                    <i class="fas fa-plus"></i>
                    Create Listing
                </a>
                <button id="myCartBtn" class="marketplace-btn" title="My Cart" style="margin-left:10px;display:inline-flex;align-items:center;gap:6px">
                    <i class="fas fa-shopping-cart"></i>
                    <span>My Cart</span>
                    <span id="myCartCount" class="badge" style="background:#0d6efd;color:#fff;border-radius:10px;padding:2px 6px;display:none">0</span>
                </button>
            </div>

    <!-- Floating Cart Button -->
    <button id="cartFab" class="cart-fab" aria-label="Open cart" title="My Cart">
      <i class="fas fa-shopping-cart"></i>
      <span id="myCartCountFab" class="badge">0</span>
    </button>
        </div>

        <div class="marketplace-actions">
            <div class="sort-section">
                <span class="sort-label">Sort by:</span>
                <select class="sort-select">
                    <option>Latest listings</option>
                    <option>Price: Low to High</option>
                    <option>Price: High to Low</option>
                    <option>Distance</option>
                </select>
                <a href="#" class="saved-items-btn">
                    <i class="far fa-heart"></i>
                    Saved Items
                    <span class="badge">0</span>
                </a>
            </div>
        </div>

        <div class="marketplace-content">
            <div class="filters-sidebar">
                <div class="filter-section">
                    <h3>Filters</h3>
                    <div class="active-filters">
                        <div class="filter-tag">
                            Organic <i class="fas fa-times"></i>
                        </div>
                        <div class="filter-tag">
                            < 5 miles <i class="fas fa-times"></i>
                        </div>
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3>Categories</h3>
                    <div class="filter-option">
                        <input type="checkbox" id="vegetables">
                        <label for="vegetables">Vegetables</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="fruits">
                        <label for="fruits">Fruits</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="herbs">
                        <label for="herbs">Herbs</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="seeds">
                        <label for="seeds">Seeds</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="tools">
                        <label for="tools">Tools</label>
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3>Price Range</h3>
                    <div class="price-range">
                        <input type="text" placeholder="Min">
                        <input type="text" placeholder="Max">
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3>Distance</h3>
                    <input type="text" class="distance-input" placeholder="Any distance">
                </div>
                
                <div class="filter-section">
                    <h3>Growing Method</h3>
                    <div class="filter-option">
                        <input type="checkbox" id="organic" checked>
                        <label for="organic">Organic</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="hydroponic">
                        <label for="hydroponic">Hydroponic</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="conventional">
                        <label for="conventional">Conventional</label>
                    </div>
                </div>
                
                <button class="apply-btn marketplace-btn">Apply Filters</button>
            </div>

            <div class="products-container">
                <div class="search-box">
                    <input type="text" placeholder="Search for produce, tools, or sellers...">
                    <button class="marketplace-btn">Search</button>
                </div>

                <div class="products-grid">
                    <% if (typeof listings !== 'undefined' && listings && listings.length > 0) { %>
                        <% listings.forEach(listing => { %>
                            <div class="product-card">
                                <a href="/listings/<%= listing._id %>" class="product-image" style="display:block">
                                    <% if (listing.images && listing.images.length > 0) { 
                                         const __raw = String(listing.images[0] || '');
                                         const __isHttp = /^https?:\/\//i.test(__raw);
                                         const __normalized = __raw.replace(/^public[\\/]/, '').replace(/\\\\/g, '/');
                                         const __src = __isHttp ? __raw : ('/' + __normalized);
                                    %>
                                        <img src="<%= __src %>" alt="<%= listing.title %>" class="lazy-load" loading="lazy">
                                    <% } else { %>
                                        <img 
                                          alt="<%= listing.title %>"
                                          class="lazy-load" 
                                          loading="lazy"
                                          src="data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='800' viewBox='0 0 1200 800'>\
  <defs>\
    <linearGradient id='g' x1='0' x2='1' y1='0' y2='1'>\
      <stop offset='0%' stop-color='%23e8f5e9'/>\
      <stop offset='100%' stop-color='%23c8e6c9'/>\
    </linearGradient>\
  </defs>\
  <rect width='1200' height='800' fill='url(%23g)'/>\
  <g fill='%2390a4ae'>\
    <circle cx='220' cy='200' r='8'/>\
    <circle cx='320' cy='260' r='6'/>\
    <circle cx='180' cy='320' r='5'/>\
    <circle cx='280' cy='360' r='7'/>\
  </g>\
  <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='36' fill='%2366886f'>FreshShare</text>\
</svg>">
                                    <% } %>
                                </a>
                                <div class="product-details">
                                    <h3 class="product-title"><a href="/listings/<%= listing._id %>" class="text-decoration-none"><%= listing.title %></a></h3>
                                    <div class="product-badges">
                                      <% if (listing.category) { %>
                                        <span class="badge badge-category"><%= listing.category.replace('_',' ') %></span>
                                      <% } %>
                                      <% if (listing.isOrganic) { %>
                                        <span class="badge badge-organic">Organic</span>
                                      <% } %>
                                      <% if (listing.groupBuy && listing.groupBuy.enabled) { %>
                                        <span class="badge badge-gb">Group Buy</span>
                                      <% } %>
                                    </div>
                                    <% 
                                      const hasExplicitUnitPrice = (typeof listing.price === 'number') && listing.price > 0;
                                      const derivedUnitPrice = (typeof listing.caseUnitPrice === 'number') 
                                        ? listing.caseUnitPrice 
                                        : ((typeof listing.casePrice === 'number' && typeof listing.caseSize === 'number' && listing.caseSize > 0) 
                                          ? (listing.casePrice / listing.caseSize) 
                                          : null);
                                      // Prefer the case breakdown price when available
                                      const displayUnitPrice = (typeof derivedUnitPrice === 'number')
                                        ? derivedUnitPrice
                                        : (hasExplicitUnitPrice ? listing.price : null);
                                      const unitLabel = listing.priceUnit || 'each';
                                    %>
                                    <div class="product-price">$<%= (typeof displayUnitPrice === 'number' ? displayUnitPrice.toFixed(2) : '0.00') %> / <%= unitLabel %></div>
                                    <% if (typeof listing.casePrice === 'number' && listing.casePrice >= 0) { %>
                                      <div class="product-price small text-muted">
                                        Case: $<%= listing.casePrice.toFixed(2) %>
                                        <% if (typeof listing.caseSize === 'number' && listing.caseSize > 0) { %>
                                          for <%= listing.caseSize %>
                                          <% if (typeof listing.caseUnitPrice === 'number') { %>
                                            (≈ $<%= listing.caseUnitPrice.toFixed(2) %> each)
                                          <% } %>
                                        <% } %>
                                      </div>
                                    <% } %>
                                    <div class="product-cta">
                                      <div class="quick-po" data-listing-id="<%= listing._id %>">
                                        <div class="small text-muted quick-po-remaining" aria-live="polite"></div>
                                        <div class="quick-po-controls" style="display:flex;align-items:center;gap:6px;justify-content:flex-end;margin-top:4px;flex-wrap:wrap">
                                          <span class="small text-muted quick-po-unit" style="margin-right:4px;white-space:nowrap">
                                            $<%= (typeof displayUnitPrice === 'number' ? displayUnitPrice.toFixed(2) : '0.00') %> / <%= unitLabel %>
                                          </span>
                                          <button type="button" class="marketplace-btn btn-sm quick-dec" title="Decrease">−</button>
                                          <input type="number" class="quick-qty" min="0" value="0" style="width:64px;padding:4px 6px;">
                                          <button type="button" class="marketplace-btn btn-sm quick-inc" title="Increase">+</button>
                                          <button type="button" class="marketplace-btn btn-sm quick-save" title="Save reservation">Reserve</button>
                                        </div>
                                      </div>
                                      <% if (listing.groupBuy && listing.groupBuy.enabled) { %>
                                      <div class="quick-gb" data-listing-id="<%= listing._id %>">
                                        <div class="small text-muted quick-gb-status" aria-live="polite"></div>
                                        <div class="mt-1">
                                          <div class="progress" style="height:6px;">
                                            <div class="progress-bar quick-gb-progress" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
                                          </div>
                                          <div class="small text-muted mt-1 quick-gb-progress-text"></div>
                                        </div>
                                        <div class="quick-gb-controls" style="display:flex;align-items:center;gap:6px;justify-content:flex-end;margin-top:4px;flex-wrap:wrap">
                                          <div class="input-group input-group-sm" style="width:140px;">
                                            <span class="input-group-text">Cases</span>
                                            <input type="number" class="form-control quick-gb-qty" min="1" step="1" placeholder="1">
                                          </div>
                                          <button type="button" class="marketplace-btn btn-sm quick-gb-commit">Commit</button>
                                          <button type="button" class="marketplace-btn btn-sm quick-gb-cancel" style="display:none">Cancel</button>
                                        </div>
                                      </div>
                                      <% } %>

                                      <a class="view-details-btn" href="/listings/<%= listing._id %>" title="View Details">View details</a>
                                    </div>
                                    <div class="product-specs">
                                      <% if (typeof listing.caseSize === 'number' && listing.caseSize > 0) { %>
                                        <div class="spec"><span>Case</span><%= listing.caseSize %></div>
                                      <% } %>
                                      <% if (listing.location && listing.location.distance) { %>
                                        <div class="spec"><span>Distance</span><%= listing.location.distance.toFixed(1) %> mi</div>
                                      <% } else { %>
                                        <div class="spec"><span>Pickup</span>Local</div>
                                      <% } %>
                                      <% if (listing.priceUnit) { %>
                                        <div class="spec"><span>Unit</span><%= listing.priceUnit %></div>
                                      <% } %>
                                    </div>
                                    <div class="product-location">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <% if (listing.location && listing.location.distance) { %>
                                            <%= listing.location.distance.toFixed(1) %> miles away
                                        <% } else { %>
                                            Local pickup
                                        <% } %>
                                    </div>
                                    <p class="product-desc"><%= listing.description %></p>
                                    <div class="product-seller">
                                        <% if (listing.seller) { %>
                                            <% const initials = listing.seller.username ? listing.seller.username.substring(0, 2).toUpperCase() : 'US'; %>
                                            <div class="seller-icon"><%= initials %></div>
                                            <%= listing.seller.username || 'Unknown Seller' %>
                                        <% } else { %>
                                            <div class="seller-icon">US</div>
                                            Unknown Seller
                                        <% } %>
                                        <div class="product-actions">
                                            <div class="action-icon">
                                                <i class="far fa-heart"></i>
                                            </div>
                                            <div class="action-icon">
                                                <a href="/listings/<%= listing._id %>" class="text-decoration-none" title="View Details">
                                                  <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            </div>
                                            <% if (user && listing.seller && String(listing.seller._id) !== String(user._id) && listing.seller.username) { %>
                                            <div class="action-icon">
                                                <a href="/messages?<%= encodeURIComponent('to') %>=<%= encodeURIComponent(listing.seller.username) %>&<%= encodeURIComponent('toId') %>=<%= encodeURIComponent(String(listing.seller._id)) %>&compose=1" class="text-decoration-none" title="Message Seller">
                                                  <i class="fas fa-envelope"></i>
                                                </a>
                                            </div>
                                            <% } %>
                                            <% if (user && listing.seller && String(listing.seller._id) === String(user._id)) { %>
                                            <div class="action-icon">
                                                <a href="/listings/<%= listing._id %>/edit" class="text-decoration-none" title="Edit Listing">
                                                  <i class="fas fa-edit"></i>
                                                </a>
                                            </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="no-listings-message">
                            <i class="fas fa-leaf"></i>
                            <h3>No listings found</h3>
                            <p>Be the first to create a listing in your area!</p>
                            <a href="/create-listing" class="marketplace-btn">Create Listing</a>
                        </div>
                    <% } %>
                    </div>


                </div>
            </div>

            <div class="shopping-cart">
                <div class="cart-section">
                    <div class="cart-header">
                        <span>Shopping Cart</span>
                        <span>0 items</span>
                    </div>
                    <div class="cart-empty">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                    </div>
                    <div class="cart-items"></div>
                    <div class="cart-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span>$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Shipping:</span>
                            <span>$0.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span>$0.00</span>
                        </div>
                    </div>
                    <button class="checkout-btn marketplace-btn">Checkout</button>
                    <button class="clear-cart-btn marketplace-btn">Clear Cart</button>
                </div>
            </div>
        </div>
    </div>

    <!-- My Cart slide-in panel -->
    <div id="myCartPanel" class="mycart-panel" aria-hidden="true">
      <div class="mycart-header">
        <div class="mycart-title"><i class="fas fa-shopping-cart me-2"></i>My Cart</div>
        <button id="myCartClose" class="mycart-close" aria-label="Close">×</button>
      </div>
      <div class="mycart-body">
        <div id="myCartList" class="mycart-list">
          <div class="mycart-empty">
            <i class="fas fa-box-open"></i>
            <div>No reservations yet</div>
          </div>
        </div>
      </div>
      <div class="mycart-footer">
        <button id="myCartCheckout" class="marketplace-btn primary"><i class="fas fa-check"></i> Checkout</button>
        <button id="myCartRefresh" class="marketplace-btn secondary"><i class="fas fa-rotate"></i> Refresh</button>
      </div>
    </div>

    <script src="/js/marketplace-init.js?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>"></script>
    <script src="/js/groupbuy-init.js?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>"></script>
    <script src="/js/toast.js?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>"></script>
    <script src="/js/cart.js?v=<%= (typeof assetVersion !== 'undefined' ? assetVersion : Date.now()) %>"></script>
</body>
</html>
