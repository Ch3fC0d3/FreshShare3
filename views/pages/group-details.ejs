<%- contentFor('style') %>
<style>
    .group-details {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .group-header {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .group-info {
        flex: 1;
        min-width: 300px;
    }

    .group-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    .group-section {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .members-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .member-card {
        text-align: center;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .member-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .member-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-bottom: 8px;
        object-fit: cover;
    }
    
    .member-role {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-top: 5px;
    }
    
    .role-admin {
        background-color: #ffd700;
        color: #333;
    }
    
    .role-member {
        background-color: #e6f7ff;
        color: #0066cc;
    }

    .events-list {
        display: grid;
        gap: 15px;
    }

    .event-card {
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.2s ease;
    }
    
    .event-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .event-actions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
    }

    .discussion-board {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
    }

    .message {
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
    
    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    
    .message-content {
        white-space: pre-wrap;
    }

    .shopping-list table {
        width: 100%;
        border-collapse: collapse;
    }

    .shopping-list th, .shopping-list td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    
    .shopping-list-actions {
        width: 100px;
    }
    
    .add-item-form {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .form-group {
        flex: 1;
        min-width: 150px;
    }
    
    .badge-category {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-right: 10px;
    }
    
    .category-neighborhood {
        background-color: #e6f7ff;
        color: #0066cc;
    }
    
    .category-community_garden {
        background-color: #f6ffed;
        color: #52c41a;
    }
    
    .category-food_bank {
        background-color: #fff7e6;
        color: #fa8c16;
    }
    
    .category-cooking_club {
        background-color: #fff0f6;
        color: #eb2f96;
    }
    
    .category-other {
        background-color: #f9f0ff;
        color: #722ed1;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-left-color: #09f;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .status-badge {
        display: inline-block;
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .status-active {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }

    .ranked-products-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .ranked-products-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .ranked-products-tabs .btn {
        border-radius: 999px;
        padding: 6px 16px;
    }

    .ranked-products-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .ranked-product-card {
        border: 1px solid #e3e8ef;
        border-radius: 10px;
        padding: 16px;
        background-color: #fff;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .ranked-product-card.highlight-active {
        border-color: #4caf50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.15);
    }

    .ranked-product-topline {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
    }

    .ranked-product-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
    }

    .ranked-product-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0;
    }

    .ranked-product-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 0.9rem;
        color: #5f6b7a;
    }

    .ranked-product-score {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 70px;
        border-radius: 8px;
        background-color: #f5f7fa;
        padding: 8px;
    }

    .ranked-product-score .score-value {
        font-size: 1.3rem;
        font-weight: 700;
    }

    .ranked-product-score .score-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #7b8794;
    }

    .ranked-product-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
    }

    .ranked-product-actions .vote-buttons {
        display: flex;
        gap: 8px;
    }

    .ranked-product-actions .vote-buttons .btn {
        min-width: 36px;
    }

    .ranked-product-links {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .ranked-products-empty {
        text-align: center;
        padding: 30px 15px;
        border: 1px dashed #d5dbe5;
        border-radius: 10px;
        background-color: #fafbfd;
        color: #5f6b7a;
    }

    .product-status-badge {
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .product-status-badge.active {
        background-color: #e6f4ea;
        color: #237a3b;
    }

    .product-status-badge.requested {
        background-color: #f4f6fb;
        color: #3f506e;
    }

    .product-rank-badge {
        position: absolute;
        top: -10px;
        left: -10px;
        background-color: #3b82f6;
        color: #fff;
        border-radius: 999px;
        padding: 6px 12px;
        font-weight: 600;
        box-shadow: 0 6px 12px rgba(59, 130, 246, 0.25);
    }

    .max-products-banner {
        background-color: #f4f6fb;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }
</style>

<%- contentFor('body') %>
<div class="group-details">
    <!-- Group Header Section -->
    <div class="group-header group-section">
        <div class="group-info">
            <h1 id="group-name"></h1>
            <div class="mb-2">
                <span id="group-category-badge" class="badge-category"></span>
                <span class="status-badge status-active">Active</span>
            </div>
            <p id="group-description"></p>
            <div class="group-meta mt-3">
                <div><i class="fas fa-users"></i> <span id="member-count"></span> members</div>
                <div><i class="fas fa-map-marker-alt"></i> <span id="group-location"></span></div>
                <div><i class="fas fa-calendar"></i> Delivery days: <span id="delivery-days"></span></div>
            </div>
        </div>
        <div class="group-actions">
            <button class="btn btn-primary" id="join-group-btn">Join Group</button>
            <button class="btn btn-outline-primary" id="leave-group-btn" style="display: none;">Leave Group</button>
            <button class="btn btn-outline-secondary" id="share-group-btn"><i class="fas fa-share-alt"></i> Share</button>
            <div id="admin-actions" style="display: none;">
                <button class="btn btn-outline-primary" id="edit-group-btn"><i class="fas fa-edit"></i> Edit Group</button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Ranked Products Section -->
            <div class="group-section" id="ranked-products-section">
                <div class="ranked-products-header">
                    <div>
                        <h3 class="mb-1">Group Picks (Ranked)</h3>
                        <div class="text-muted small">Sorted by score (upvotes – downvotes). Top items become active automatically.</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" id="refresh-products-btn">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="btn btn-primary" id="suggest-product-btn">
                            <i class="fas fa-plus"></i> Suggest a Product
                        </button>
                    </div>
                </div>

                <div class="max-products-banner" id="max-products-banner" style="display: none;">
                    <div>
                        <strong>Active product limit:</strong> <span id="max-products-count">20</span>
                        <span class="text-muted" id="active-products-summary"></span>
                    </div>
                    <div class="badge bg-primary-subtle text-primary" id="active-products-count-badge">0 Active</div>
                </div>

                <div class="ranked-products-tabs">
                    <button class="btn btn-outline-secondary active" data-filter="all" id="products-tab-all">All</button>
                    <button class="btn btn-outline-secondary" data-filter="active" id="products-tab-active">Active</button>
                    <button class="btn btn-outline-secondary" data-filter="requested" id="products-tab-requested">Requested</button>
                    <button class="btn btn-outline-secondary" data-filter="mine" id="products-tab-mine">Mine</button>
                    <button class="btn btn-outline-secondary" data-filter="pinned" id="products-tab-pinned">Pinned</button>
                </div>

                <div class="alert alert-info mt-3" id="products-info-banner" style="display: none;"></div>

                <div class="ranked-products-list mt-3" id="ranked-products-list"></div>
                <div class="ranked-products-empty mt-3" id="ranked-products-empty" style="display: none;">
                    <p class="mb-2">No requests yet—be the first to suggest a product.</p>
                    <button class="btn btn-primary" id="empty-state-suggest-btn"><i class="fas fa-plus"></i> Suggest a Product</button>
                </div>
            </div>

            <!-- Suggest Product Modal -->
            <div class="modal fade" id="suggest-product-modal" tabindex="-1" aria-labelledby="suggest-product-modal-label" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="suggest-product-modal-label">Suggest a Product</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="suggest-product-error" class="alert alert-danger" style="display: none;"></div>
                            <form id="suggest-product-form">
                                <div class="mb-3">
                                    <label for="suggest-product-name" class="form-label">Product Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="suggest-product-name" placeholder="e.g., Organic Honey" required>
                                </div>
                                <div class="mb-3">
                                    <label for="suggest-product-note" class="form-label">Why should the group consider this?</label>
                                    <textarea class="form-control" id="suggest-product-note" rows="3" placeholder="Describe the benefits or reason for adding this product."></textarea>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="suggest-product-image" class="form-label">Image URL</label>
                                        <input type="url" class="form-control" id="suggest-product-image" placeholder="https://example.com/image.jpg">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="suggest-product-url" class="form-label">Product Link</label>
                                        <input type="url" class="form-control" id="suggest-product-url" placeholder="https://supplier.com/listing">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="submit-suggest-product-btn">Submit Suggestion</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shopping List Section -->
            <div class="group-section shopping-list">
                <div class="section-header">
                    <h3>Shopping List</h3>
                    <button class="btn btn-sm btn-primary" id="add-item-toggle"><i class="fas fa-plus"></i> Create Listing</button>
                </div>
                <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-2 mt-3">
                    <div class="schedule-summary">
                        <div><strong>Order by:</strong> <span id="order-by-date-display">Not set</span></div>
                        <div><strong>Delivery date:</strong> <span id="delivery-date-display">Not set</span></div>
                    </div>
                    <div id="schedule-admin-actions" class="d-none">
                        <button class="btn btn-outline-secondary btn-sm" id="edit-schedule-btn"><i class="fas fa-calendar-plus"></i> Edit schedule</button>
                    </div>
                </div>
                <div id="schedule-form" class="card card-body mt-3" style="display: none;">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="order-by-input-day" class="form-label">Order by day</label>
                            <select class="form-select" id="order-by-input-day">
                                <option value="">Select day</option>
                                <option value="Sunday">Sunday</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="order-by-input-time" class="form-label">Order by time</label>
                            <input type="time" class="form-control" id="order-by-input-time">
                        </div>
                        <div class="col-md-3">
                            <label for="delivery-day-input" class="form-label">Delivery day</label>
                            <select class="form-select" id="delivery-day-input">
                                <option value="">Select day</option>
                                <option value="Sunday">Sunday</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="delivery-time-input" class="form-label">Delivery time</label>
                            <input type="time" class="form-control" id="delivery-time-input">
                        </div>
                    </div>
                    <div id="schedule-form-error" class="text-danger small mt-2" style="display: none;"></div>
                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="cancel-schedule-btn">Cancel</button>
                        <button type="button" class="btn btn-primary btn-sm" id="save-schedule-btn">Save schedule</button>
                    </div>
                </div>
                
                <!-- Order-By Warning Banner -->
                <div id="order-by-warning" class="alert mt-3" style="display: none;"></div>
                
                <!-- Shopping List Table -->
                <div class="table-responsive mt-3">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Vendor</th>
                                <th>Case Price</th>
                                <th>Quantity</th>
                                <th>Total Units</th>
                                <th class="shopping-list-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shopping-list-body">
                            <!-- Shopping list items will be added here -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-shopping-list" class="text-center py-4" style="display: none;">
                    <p class="text-muted">No items in the shopping list yet.</p>
                </div>
            </div>

            <!-- Discussion Board Section -->
            <div class="group-section">
                <div class="section-header">
                    <h3>Discussion Board</h3>
                </div>
                <div class="discussion-board" id="discussion-board">
                    <!-- Messages will be added here -->
                </div>
                <div id="empty-discussion" class="text-center py-4" style="display: none;">
                    <p class="text-muted">No messages yet. Start the conversation!</p>
                </div>
                <div class="mt-3">
                    <textarea class="form-control" id="message-input" placeholder="Write a message..."></textarea>
                    <div class="d-flex justify-content-end mt-2">
                        <button class="btn btn-primary" id="send-message-btn">Send Message</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Events Section -->
            <div class="group-section">
                <div class="section-header">
                    <h3>Upcoming Events</h3>
                    <button class="btn btn-sm btn-primary" id="create-event-btn"><i class="fas fa-plus"></i> Create Event</button>
                </div>
                <div class="events-list" id="events-list">
                    <!-- Events will be added here -->
                </div>
                <div id="empty-events" class="text-center py-4" style="display: none;">
                    <p class="text-muted">No upcoming events.</p>
                </div>
                
                <!-- Create Event Form (initially hidden) -->
                <div id="create-event-form" class="mt-3" style="display: none;">
                    <h5>Create New Event</h5>
                    <div class="form-group">
                        <label for="event-title">Event Title</label>
                        <input type="text" class="form-control" id="event-title" placeholder="Enter event title">
                    </div>
                    <div class="form-group">
                        <label for="event-date">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="event-date">
                    </div>
                    <div class="form-group">
                        <label for="event-location">Location</label>
                        <input type="text" class="form-control" id="event-location" placeholder="Enter location">
                    </div>
                    <div class="form-group">
                        <label for="event-description">Description</label>
                        <textarea class="form-control" id="event-description" placeholder="Describe the event"></textarea>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" id="save-event-btn">Create Event</button>
                        <button type="button" class="btn btn-outline-secondary ml-2" id="cancel-event-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div class="group-section">
                <div class="section-header">
                    <h3>Members</h3>
                    <button class="btn btn-sm btn-outline-primary" id="invite-member-btn"><i class="fas fa-user-plus"></i> Invite</button>
                </div>
                <div class="members-grid" id="members-grid">
                    <!-- Members will be added here -->
                </div>
                <div id="empty-members" class="text-center py-4" style="display: none;">
                    <p class="text-muted">No members yet.</p>
                </div>
            </div>
            
            <!-- Group Rules Section -->
            <div class="group-section">
                <h3>Group Rules</h3>
                <div id="group-rules">
                    <!-- Rules will be added here -->
                </div>
                <div id="empty-rules" class="text-center py-4" style="display: none;">
                    <p class="text-muted">No rules have been set for this group.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Messages -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 5">
        <div id="status-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Toast message will be added here -->
            </div>
        </div>
    </div>
</div>

<%- contentFor('script') %>
<script src="/js/group-details.js"></script>
