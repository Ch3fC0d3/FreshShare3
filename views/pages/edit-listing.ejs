<%- contentFor('style') %>
<link rel="stylesheet" href="/css/main.css">

<%- contentFor('body') %>
<div class="main-content" id="editListingPage" data-auth="<%= !!user %>" data-listing-id="<%= listingId %>">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">Edit Listing</h1>
      <% if (user) { %>
      <span class="badge bg-success">
        <i class="fas fa-user me-1"></i>
        Logged in as <strong><%= user.username %></strong>
      </span>
      <% } %>
    </div>

    <% if (!user) { %>
    <div class="alert alert-warning d-flex align-items-center" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <div>Please log in to edit listings. <a href="/login" class="alert-link">Log in</a></div>
    </div>
    <% } %>

    <div id="editListingAlert" class="alert" role="alert" style="display:none"></div>

    <% if (user) { %>
    <form id="editListingForm">
      <!-- Basic Information -->
      <div class="form-section">
        <h3>Basic Information</h3>
        <div class="mb-3">
          <label for="title" class="form-label">Item*</label>
          <input type="text" class="form-control" id="title" name="title" required>
        </div>
        <div class="mb-3">
          <label for="description" class="form-label">Description*</label>
          <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="price" class="form-label">Price*</label>
            <input type="number" min="0" step="0.01" class="form-control" id="price" name="price" required>
            <div class="form-text">If Unit is <strong>Case</strong>, this Price is treated as the <strong>Case Price</strong>.</div>
          </div>
          <div class="col-md-4 mb-3">
            <label for="priceUnit" class="form-label">Price Unit</label>
            <select class="form-select" id="priceUnit" name="priceUnit">
              <option value="">Select unit</option>
              <option value="each">Each</option>
              <option value="lb">Per pound (lb)</option>
              <option value="kg">Per kilogram (kg)</option>
              <option value="oz">Per ounce (oz)</option>
              <option value="bunch">Per bunch</option>
              <option value="hour">Per hour</option>
              <option value="case">Case</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label for="category" class="form-label">Category*</label>
            <select class="form-select" id="category" name="category" required>
              <option value="">Select category</option>
              <option>Produce</option>
              <option>Dairy</option>
              <option>Meat</option>
              <option>Seafood</option>
              <option>Bakery</option>
              <option>Pantry</option>
              <option>Beverages</option>
              <option>Frozen</option>
              <option>Prepared</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="casePrice" class="form-label">Case Price</label>
            <input type="number" min="0" step="0.01" class="form-control" id="casePrice" name="casePrice" placeholder="Total price per case">
            <div class="form-text">Total price for one wholesale case. Combine with Case Size below.</div>
            <div class="form-text" id="priceBreakdown"></div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="quantity" class="form-label">Quantity</label>
            <input type="number" min="0" step="1" class="form-control" id="quantity" name="quantity">
          </div>
          <div class="col-md-4 mb-3">
            <label for="caseSize" class="form-label">Case Size</label>
            <input type="number" min="1" step="1" class="form-control" id="caseSize" name="caseSize">
          </div>
          <div class="col-md-4 mb-3 form-check mt-4">
            <input type="checkbox" class="form-check-input" id="isOrganic" name="isOrganic">
            <label class="form-check-label" for="isOrganic">Organic</label>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="upcCode" class="form-label">UPC Code</label>
            <input type="text" class="form-control" id="upcCode" name="upcCode">
          </div>
          <div class="col-md-6 mb-3">
            <label for="tags" class="form-label">Tags (comma separated)</label>
            <input type="text" class="form-control" id="tags" name="tags">
          </div>
        </div>
      </div>

      <!-- Group Buy -->
      <div class="form-section">
        <h3>Group Buy</h3>
        <div class="form-check form-switch mb-2">
          <input type="checkbox" class="form-check-input switch-lg" id="groupBuy-enabled" name="groupBuy[enabled]">
          <label class="form-check-label fw-semibold" for="groupBuy-enabled">Enable group buy</label>
        </div>
        <div class="alert alert-info py-2" role="alert">
          <i class="bi bi-people me-1"></i>
          Buyers can <strong>commit cases together</strong>. When the target is reached by the deadline, place the order.
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="groupBuy-minCases" class="form-label">Minimum Cases</label>
            <input type="number" min="1" step="1" class="form-control" id="groupBuy-minCases" name="groupBuy[minCases]" placeholder="e.g., 2">
          </div>
          <div class="col-md-4 mb-3">
            <label for="groupBuy-targetCases" class="form-label">Target Cases</label>
            <input type="number" min="1" step="1" class="form-control" id="groupBuy-targetCases" name="groupBuy[targetCases]" placeholder="e.g., 6">
          </div>
          <div class="col-md-4 mb-3">
            <label for="groupBuy-deadline" class="form-label">Deadline</label>
            <input type="datetime-local" class="form-control" id="groupBuy-deadline" name="groupBuy[deadline]">
          </div>
        </div>
      </div>

      <!-- Per-Piece Ordering -->
      <div class="form-section">
        <h3>Per-Piece Ordering</h3>
        <div class="form-check form-switch mb-2">
          <input type="checkbox" class="form-check-input switch-lg" id="pieceOrdering-enabled" name="pieceOrdering[enabled]">
          <label class="form-check-label fw-semibold" for="pieceOrdering-enabled">Enable per-piece ordering with rolling cases</label>
        </div>
        <div class="alert alert-info py-2 po-explainer" role="alert">
          <i class="bi bi-info-circle me-1"></i>
          <strong>Shoppers reserve individual pieces</strong> up to a case. When the case fills, it locks and a new case opens automatically.
        </div>
      </div>

      <!-- Commitments Summary -->
      <div class="form-section" id="commitmentsSection">
        <h3>Commitments Summary</h3>
        <div id="pendingChangesNote" class="text-warning small" style="display:none">Pending changes not yet saved</div>
        <div id="commitmentsContent" class="small text-muted">Loading...</div>
        <div class="mt-2 d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshCommitmentsBtn">Refresh</button>
          <button type="button" class="btn btn-outline-danger btn-sm" id="cancelGbBtn" style="display:none">Cancel my group buy commitment</button>
          <button type="button" class="btn btn-outline-danger btn-sm" id="cancelPoBtn" style="display:none">Cancel my piece reservation</button>
        </div>
      </div>

      <!-- Vendor selection -->
      <div class="form-section">
        <h3>Vendor <small class="text-muted">(optional)</small></h3>
        <div class="row align-items-end">
          <div class="col-md-8 mb-3">
            <label for="saved-vendor" class="form-label">Saved Vendor</label>
            <select class="form-select" id="saved-vendor">
              <option value="">Select a saved vendor</option>
            </select>
            <div id="vendorsFetchStatus" class="form-text text-muted" style="display:none"></div>
            <a href="#" id="vendorsRetry" class="small" style="display:none">Retry</a>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label d-block">&nbsp;</label>
            <div class="d-grid gap-2">
              <button type="button" id="vendorQuickPickBtn" class="btn btn-secondary w-100"><i class="fas fa-user-check me-1"></i> Quick Pick</button>
              <a href="/vendors?return=<%= encodeURIComponent('/listings/' + listingId + '/edit') %>" class="btn btn-outline-secondary w-100"><i class="fas fa-plus me-1"></i> Add Vendor</a>
            </div>
          </div>
        </div>
        <input type="hidden" id="vendorId" name="vendorId" />
      </div>

      <!-- Vendor Quick Pick Modal (Bootstrap) -->
      <div class="modal fade" id="vendorQuickPickModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Select a Vendor</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="vendorQuickPickClose"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <input id="vendorQuickPickSearch" type="text" class="form-control" placeholder="Search vendors by name or city..." autocomplete="off">
              </div>
              <div id="vendorQuickPickList" class="list-group">
                <div class="p-3 text-muted">Loadingâ€¦</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="/marketplace" class="btn btn-outline-secondary">Cancel</a>
        <button type="button" class="btn btn-danger ms-auto" id="deleteListingBtn">Delete Listing</button>
      </div>
    </form>
    <% } %>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteLabel">Delete Listing?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        This will permanently delete this listing. This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
  </div>

<%- contentFor('script') %>
<script src="/js/edit-listing-page.js"></script>
