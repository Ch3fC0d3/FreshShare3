<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify Food Autocomplete</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/autocomplete.css">
  <style>
    body {
      padding: 20px;
    }
    .results-container {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    .api-log {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f5f5f5;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
    }
    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .log-entry.success {
      color: green;
    }
    .log-entry.error {
      color: red;
    }
    .log-entry.info {
      color: blue;
    }
    .log-entry.mock {
      color: orange;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Food Autocomplete Verification</h1>
    <p>This page tests the food autocomplete functionality to verify it's working correctly.</p>
    
    <div class="row">
      <div class="col-md-6">
        <div class="mb-3">
          <label for="foodSearch" class="form-label">Search for food items:</label>
          <input type="text" class="form-control" id="foodSearch" placeholder="Type to search (e.g., apple, banana, etc.)">
          <div class="form-text">Start typing to see autocomplete results from the USDA API</div>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-md-6">
        <h3>Test Results</h3>
        <div class="results-container">
          <div id="apiStatus">API Status: <span class="badge bg-secondary">Not tested yet</span></div>
          <div id="mockStatus">Using Mock Data: <span class="badge bg-secondary">Unknown</span></div>
          <div id="resultsCount">Results: <span>0</span></div>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-12">
        <h3>API Logs</h3>
        <div class="api-log" id="apiLog">
          <div class="log-entry info">Waiting for search input...</div>
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-12">
        <h3>Test Direct API</h3>
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="directApiQuery" placeholder="Enter search term">
          <button class="btn btn-primary" id="testDirectApiBtn">Test Direct USDA API</button>
        </div>
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="localApiQuery" placeholder="Enter search term">
          <button class="btn btn-success" id="testLocalApiBtn">Test Local API Endpoint</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/food-autocomplete.js"></script>
  <script>
    // DOM elements
    const foodSearchInput = document.getElementById('foodSearch');
    const apiStatusEl = document.getElementById('apiStatus').querySelector('span');
    const mockStatusEl = document.getElementById('mockStatus').querySelector('span');
    const resultsCountEl = document.getElementById('resultsCount').querySelector('span');
    const apiLogEl = document.getElementById('apiLog');
    const directApiQueryInput = document.getElementById('directApiQuery');
    const localApiQueryInput = document.getElementById('localApiQuery');
    const testDirectApiBtn = document.getElementById('testDirectApiBtn');
    const testLocalApiBtn = document.getElementById('testLocalApiBtn');
    
    // Add log entry
    function addLogEntry(message, type = 'info') {
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      logEntry.textContent = message;
      apiLogEl.appendChild(logEntry);
      apiLogEl.scrollTop = apiLogEl.scrollHeight;
    }
    
    // Initialize food autocomplete with custom callbacks
    document.addEventListener('DOMContentLoaded', function() {
      addLogEntry('Page loaded, initializing food autocomplete...', 'info');
      
      try {
        // Override console.log to capture logs
        const originalConsoleLog = console.log;
        console.log = function(...args) {
          originalConsoleLog.apply(console, args);
          if (args[0] && typeof args[0] === 'string' && args[0].includes('🍎')) {
            addLogEntry(args.join(' '), 'info');
          }
        };
        
        // Override console.warn to capture warnings
        const originalConsoleWarn = console.warn;
        console.warn = function(...args) {
          originalConsoleWarn.apply(console, args);
          addLogEntry(args.join(' '), 'error');
        };
        
        // Initialize food autocomplete
        const foodAutocomplete = new FoodAutocomplete(foodSearchInput, {
          maxResults: 10,
          minLength: 2,
          delay: 300,
          onResults: function(results, isMockData) {
            // Update UI with results
            apiStatusEl.className = 'badge ' + (results.length > 0 ? 'bg-success' : 'bg-danger');
            apiStatusEl.textContent = results.length > 0 ? 'Working' : 'No Results';
            
            mockStatusEl.className = 'badge ' + (isMockData ? 'bg-warning' : 'bg-success');
            mockStatusEl.textContent = isMockData ? 'YES (Using Mock Data)' : 'NO (Using Real API Data)';
            
            resultsCountEl.textContent = results.length;
            
            addLogEntry(`Received ${results.length} results. Using mock data: ${isMockData}`, isMockData ? 'mock' : 'success');
            
            if (results.length > 0) {
              addLogEntry('First 3 results:', 'info');
              results.slice(0, 3).forEach((item, i) => {
                addLogEntry(`${i+1}. ${item.description || item.name} (${item.category || 'No category'})`, 'success');
              });
            }
          },
          onError: function(error) {
            apiStatusEl.className = 'badge bg-danger';
            apiStatusEl.textContent = 'Error';
            addLogEntry(`Error: ${error.message}`, 'error');
          }
        });
        
        addLogEntry('Food autocomplete initialized successfully', 'success');
      } catch (error) {
        addLogEntry(`Error initializing food autocomplete: ${error.message}`, 'error');
      }
    });
    
    // Test direct USDA API
    testDirectApiBtn.addEventListener('click', async function() {
      const query = directApiQueryInput.value.trim();
      if (!query) {
        addLogEntry('Please enter a search term', 'error');
        return;
      }
      
      addLogEntry(`Testing direct USDA API with query: "${query}"`, 'info');
      
      try {
        const API_KEY = 'DEMO_KEY'; // Using demo key for testing
        const params = new URLSearchParams({
          api_key: API_KEY,
          query: query,
          dataType: ['Foundation', 'Survey (FNDDS)', 'SR Legacy'].join(','),
          pageSize: 10,
          pageNumber: 1
        });
        
        addLogEntry('Sending request to USDA API...', 'info');
        
        const response = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?${params}`);
        const data = await response.json();
        
        addLogEntry('Direct USDA API response received!', 'success');
        addLogEntry(`Total hits: ${data.totalHits || 0}`, 'success');
        addLogEntry(`Foods count: ${data.foods?.length || 0}`, 'success');
        
        if (data.foods && data.foods.length > 0) {
          addLogEntry('First 3 results from USDA API:', 'info');
          data.foods.slice(0, 3).forEach((food, index) => {
            addLogEntry(`${index + 1}. ${food.description} (${food.foodCategory || 'No category'})`, 'success');
          });
        }
      } catch (error) {
        addLogEntry(`Error testing USDA API directly: ${error.message}`, 'error');
      }
    });
    
    // Test local API endpoint
    testLocalApiBtn.addEventListener('click', async function() {
      const query = localApiQueryInput.value.trim();
      if (!query) {
        addLogEntry('Please enter a search term', 'error');
        return;
      }
      
      addLogEntry(`Testing local API endpoint with query: "${query}"`, 'info');
      
      try {
        addLogEntry('Sending request to local API...', 'info');
        
        const response = await fetch(`/api/marketplace/food-search?query=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        addLogEntry('Local API response received!', 'success');
        addLogEntry(`Success flag: ${data.success}`, data.success ? 'success' : 'error');
        addLogEntry(`Using mock data: ${data.isMockData ? 'YES' : 'NO'}`, data.isMockData ? 'mock' : 'success');
        
        const results = data.data || data.items || [];
        addLogEntry(`Results count: ${results.length}`, 'success');
        
        if (results.length > 0) {
          addLogEntry('First 3 results from local API:', 'info');
          results.slice(0, 3).forEach((item, i) => {
            addLogEntry(`${i+1}. ${item.description || item.name} (${item.category || 'No category'})`, 'success');
          });
        }
      } catch (error) {
        addLogEntry(`Error testing local API: ${error.message}`, 'error');
      }
    });
  </script>
</body>
</html>
